# TeX Live Upgrade & Engine Internals

This document explains the current TeX Live 2020 system and the steps required to upgrade to TeX Live 2025.

## Current System (TeX Live 2020)

The system is based on **pdfTeX 1.40.22** and **BibTeX 0.99d** from the TeX Live 2020 distribution.

### 1. WASM Engine & File Lookup
The WASM engine uses a customized `kpathsea` library. When the C code attempts to find a file (style, font, etc.), it follows this flow:
1. **Local Check (MEMFS)**: It first looks in the Emscripten virtual filesystem (including the pre-loaded `/tex` cache).
2. **JS Fallback**: If not found, a wrapper (`wasm-build/kpse-hook.c`) intercepts the call and triggers `kpse_find_file_js` in `wasm-build/worker-template.js`.
3. **Synchronous XHR**: The JS worker performs a **synchronous XMLHttpRequest** to the TeX Live CDN. Synchronous calls are used because the C-side `kpathsea` lookup is blocking.

### 2. S3/CDN Package Structure
Packages are hosted on S3 (served via CloudFront) in a flattened structure based on kpathsea format IDs:
- `pdftex/26/`: TeX sources (`.sty`, `.cls`, `.tex`)
- `pdftex/3/`: TFM font metrics
- `pdftex/32/`: Type1 fonts (`.pfb`)
- `pdftex/10/`: Format files (`.fmt`)
- `pdftex/7/`: BibTeX styles (`.bst`)

The URL pattern is: `${texliveUrl}/pdftex/${formatId}/${filename}`.

### 3. Format Files (.fmt)
A `.fmt` file is a memory dump of the TeX state after loading a set of macros (like LaTeX).
- **Base Format**: `public/swiftlatex/swiftlatexpdftex.fmt`. This is the core LaTeX kernel.
- **Preamble Caching**: For faster edits, the system snapshots the document preamble and builds a temporary `.fmt` file in the browser.

---

## Upgrade Guide (TeX Live 2025)

Upgrading to TeX Live 2025 requires updating the WASM engine, the S3 package repository, and the base format file.

### Step 1: Update S3 Packages
Use `scripts/sync-texlive-s3.sh` to extract files from the latest TeX Live and upload them.

```bash
# Edit scripts/sync-texlive-s3.sh to set TEXLIVE_YEAR=2025
# and update TEXMF_TARBALL/URL to the 2025 versions.

./scripts/sync-texlive-s3.sh --upload
```

### Step 2: Build New WASM Engine
The WASM engine must be compiled with the latest pdfTeX source to ensure compatibility with 2025 format files.

1. Update the TeX Live source in `wasm-build/`.
2. Run the build pipeline:
   ```bash
   cd wasm-build
   ./build.sh
   ```
3. Copy `dist/*` to `public/swiftlatex/`.

### Step 3: Extract New Base Format
Once the engine and CDN are updated, you must extract a new base `.fmt` file that matches the 2025 kernel.

```bash
# Ensure local texlive server is running (pointing to 2025 assets)
# Then run the extraction script:
node scripts/extract-format.mjs
```
This script uses Playwright to run the editor in a headless browser, trigger a compilation, and capture the `.fmt` file generated by the new WASM engine.

---

## Deployment Strategy: Side-by-Side (Zero Downtime)

To keep the existing TeX Live 2020 environment operational while working on the 2025 upgrade, follow a versioned path strategy.

### 1. Versioned S3 Structure
Instead of overwriting the root `pdftex/` folder, use versioned prefixes in your S3 bucket:
- `s3://your-bucket/2020/pdftex/...` (Existing)
- `s3://your-bucket/2025/pdftex/...` (New)

Update your `scripts/sync-texlive-s3.sh` or manual `aws s3 sync` commands to include the version prefix.

### 2. Client-Side Switching
The `LatexEditor` SDK allows you to specify the `texliveUrl`. You can point different instances of your application to different versions:

```typescript
// Legacy 2020 instance
const editor2020 = new LatexEditor(container, {
  texliveUrl: 'https://cdn.example.com/2020/'
})

// New 2025 instance
const editor2025 = new LatexEditor(container, {
  texliveUrl: 'https://cdn.example.com/2025/'
})
```

### 3. Verification & Cutover
1. **Staging**: Deploy the 2025 WASM engine and assets to a staging environment pointing to the `/2025/` S3 prefix.
2. **Validation**: Run E2E tests and manual checks.
3. **Cutover**: Once verified, update the production environment's `VITE_TEXLIVE_URL` or constructor options to point to the new path.

This approach ensures that the 2020 environment remains untouched and functional throughout the entire upgrade process.
- [docs/engine.md](engine.md): High-level engine setup.
- [docs/architecture.md](architecture.md): System architecture overview.
